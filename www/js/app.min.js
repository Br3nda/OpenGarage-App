angular.module("opengarage",["ionic","opengarage.controllers","opengarage.utils"]).run(function($state,$ionicPlatform,$ionicScrollDelegate,$ionicHistory,$location,$document,$window,$rootScope,$ionicLoading,$ionicPopup,$timeout,Utils){$ionicPlatform.ready(function(){$rootScope.open=function(url){window.open(url,"_blank","toolbarposition=top")},window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&window.cordova.plugins.Keyboard.hideKeyboardAccessoryBar&&window.cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&(window.StatusBar.styleLightContent(),window.StatusBar.backgroundColorByHexString("#444"),angular.element($window).on("statusTap",function(){$ionicScrollDelegate.scrollTop()})),$timeout(function(){try{navigator.splashscreen.hide()}catch(err){}},500)}),$rootScope.version=window.appVersion,$rootScope.loadingCount=0,$rootScope.controllers=[],$rootScope.$on("loading:show",function(e,data){$rootScope.loadingCount++,$rootScope.canceller=data.canceller.resolve,$ionicLoading.show({template:"<ion-spinner></ion-spinner><br>One moment please<br><button class='button white icon-left ion-ios-close-outline button-clear' ng-click='$root.canceller()'>Cancel</button>"})}),$rootScope.$on("loading:hide",function(){$rootScope.loadingCount--,$rootScope.loadingCount<=0&&($rootScope.loadingCount=0,$ionicLoading.hide())}),$rootScope.$on("$ionicView.afterEnter",function(){$document[0].title="OpenGarage"});var firstLoadHandler=$rootScope.$on("$stateChangeStart",function(event){firstLoadHandler(),event.preventDefault(),Utils.storage.get(["activeController","controllers"],function(data){try{$rootScope.controllers=JSON.parse(data.controllers),$rootScope.activeController=JSON.parse(data.activeController)}catch(err){}$rootScope.controllers||($rootScope.controllers=[]),$rootScope.activeController&&"object"==typeof $rootScope.activeController?$state.go("app.home"):$state.go("app.controllerSelect")})});angular.element(window).on("resize",function(){$rootScope.$broadcast("window:resize"),window.innerWidth>768&&angular.element("#mainContent").width(window.innerWidth-275)})}).config(function($stateProvider,$urlRouterProvider,$httpProvider,$compileProvider,$ionicConfigProvider){/MSIE\s|Trident\/|Edge\//.test(window.navigator.userAgent)&&$ionicConfigProvider.platform.default.spinner.icon("android"),$ionicConfigProvider.backButton.previousTitleText(!1).text("Back"),/Firefox/.test(navigator.userAgent)&&$ionicConfigProvider.scrolling.jsScrolling(!1),$compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|chrome-extension|app|local|file):/),$compileProvider.imgSrcSanitizationWhitelist(/^\s*(https?|ftp|file|content|blob|ms-appx|x-wmapp0|chrome-extension|app|local):|data:image\//),$stateProvider.state("app",{url:"/app",abstract:!0,templateUrl:"templates/menu.html",controller:"MenuCtrl"}).state("app.home",{url:"/home",views:{menuContent:{templateUrl:"templates/home.html",controller:"HomeCtrl"}},resolve:{checkValid:function($timeout,$q,$state,$rootScope,$filter,Utils){var total=$rootScope.controllers.length,filterFilter=$filter("filter"),invalidOrg=!(!$rootScope.activeController||0!==filterFilter($rootScope.controllers,{mac:$rootScope.activeController.mac}).length);return $rootScope.activeController||1!==total?!$rootScope.activeController||invalidOrg?(delete $rootScope.activeController,Utils.storage.remove("activeController"),$timeout(function(){$state.go("app.controllerSelect")}),$q.reject()):void 0:($rootScope.activeController=$rootScope.controllers[0],void Utils.storage.set({activeController:JSON.stringify($rootScope.activeController)}))}}}).state("app.controllerSelect",{url:"/controllerSelect",views:{menuContent:{templateUrl:"templates/controllerSelect.html",controller:"ControllerSelectCtrl"}}}).state("app.history",{url:"/history",views:{menuContent:{templateUrl:"templates/history.html",controller:"HistoryCtrl"}},resolve:{checkValid:function($rootScope,$q){if(!$rootScope.activeController)return $q.reject()}}}).state("app.settings",{url:"/settings",views:{menuContent:{templateUrl:"templates/settings.html",controller:"SettingsCtrl"}},resolve:{checkValid:function($rootScope,$q){if(!$rootScope.activeController)return $q.reject()}}}).state("app.help",{url:"/help",views:{menuContent:{templateUrl:"templates/help.html"}}}).state("otherwise",{url:"*path",template:"",controller:function($state,$rootScope){$rootScope.activeController?$state.go("app.home"):$state.go("app.controllerSelect")}}),$httpProvider.interceptors.push(function($rootScope,$q,$injector){return{request:function(config){if(!config.suppressLoader){var canceller=$q.defer();config.timeout=canceller.promise,"number"!=typeof config.retryCount&&(config.retryCount=0),$rootScope.$broadcast("loading:show",{canceller:canceller})}return config},response:function(response){return response.config.suppressLoader||$rootScope.$broadcast("loading:hide"),response},responseError:function(error){if(error.config.timeout&&error.config.timeout.$$state&&1===error.config.timeout.$$state.status&&(error.canceled=!0),error.config.suppressLoader||$rootScope.$broadcast("loading:hide"),error.status<=0&&!error.canceled){if(error.config.retryCount<3){var $http=$injector.get("$http");return error.config.retryCount++,$http(error.config)}return error.retryFailed=!0,error.canceled=!0,$q.reject(error)}return $q.reject(error)}}}),$ionicConfigProvider.views.forwardCache(!0)}),angular.module("opengarage.controllers",["opengarage.utils"]).controller("ControllerSelectCtrl",function($scope,$state,$rootScope,$filter,$ionicHistory,Utils){$scope.data={showDelete:!1},$scope.setController=function(index){$rootScope.activeController=$rootScope.controllers[index],Utils.storage.set({activeController:JSON.stringify($rootScope.activeController)}),$ionicHistory.nextViewOptions({historyRoot:!0}),$state.go("app.home")},$scope.deleteController=function(index){$rootScope.controllers.indexOf($rootScope.activeController)===index&&(delete $rootScope.activeController,Utils.storage.remove("activeController")),$rootScope.controllers.splice(index,1),Utils.storage.set({controllers:JSON.stringify($rootScope.controllers)})},$scope.moveItem=function(item,fromIndex,toIndex){$rootScope.controllers.splice(fromIndex,1),$rootScope.controllers.splice(toIndex,0,item),Utils.storage.set({controllers:JSON.stringify($rootScope.controllers)})}}).controller("HistoryCtrl",function($scope,Utils){$scope.$on("$ionicView.beforeEnter",function(){Utils.getLogs(function(reply){reply?($scope.isLocal=!0,$scope.logs=reply):$scope.isLocal=!1})})}).controller("SettingsCtrl",function($scope,$state,$ionicPopup,Utils){$scope.settings={},$scope.changePassword=Utils.changePassword,$scope.restart=Utils.restartController,$scope.submit=function(){Utils.saveOptions($scope.settings,function(reply){var text;reply?(text="Settings saved successfully!",$state.go("app.home")):text="Unable to save settings. Please check the connection to the device and try again.",$ionicPopup.alert({template:"<p class='center'>"+text+"</p>"})})},$scope.$on("$ionicView.beforeEnter",function(){Utils.getControllerOptions(function(reply){reply?($scope.isLocal=!0,delete reply.mod,delete reply.fwv,$scope.settings=reply):$scope.isLocal=!1},null,!0)})}).controller("MenuCtrl",function($scope,$ionicActionSheet,$ionicSideMenuDelegate,Utils){$scope.showAddController=function(){$ionicActionSheet.show({buttons:[{text:"Add by IP"},{text:"Add by Blynk Token"}],titleText:"Add Controller",cancelText:"Cancel",buttonClicked:function(index){return 1===index?Utils.showAddBlynk():Utils.showAddController(),!0}})},$scope.closeMenu=function(){$ionicSideMenuDelegate.toggleLeft(!1)}}).controller("HomeCtrl",function($rootScope,$scope,$timeout,Utils){var interval;$scope.toggleDoor=Utils.toggleDoor,$scope.$on("$ionicView.beforeLeave",function(){clearInterval(interval)}),$scope.$on("$ionicView.beforeEnter",function(){interval=setInterval(Utils.updateController,3e3)}),$rootScope.$on("controllerUpdated",function(){$timeout(function(){$scope.$apply()})})}),angular.module("opengarage.utils",[]).factory("Utils",["$injector","$rootScope",function($injector,$rootScope){var $http,$q,$filter,$ionicPopup,isFireFox=/Firefox/.test(window.navigator.userAgent),isIE=/MSIE\s|Trident\/|Edge\//.test(window.navigator.userAgent),storage={get:function(query,callback){callback=callback||function(){};var i,data={};"string"==typeof query&&(query=[query]);for(i in query)query.hasOwnProperty(i)&&(data[query[i]]=localStorage.getItem(query[i]));callback(data)},set:function(query,callback){callback=callback||function(){};var i;if("object"==typeof query)for(i in query)query.hasOwnProperty(i)&&localStorage.setItem(i,query[i]);callback(!0)},remove:function(query,callback){callback=callback||function(){};var i;"string"==typeof query&&(query=[query]);for(i in query)query.hasOwnProperty(i)&&localStorage.removeItem(query[i]);callback(!0)}},getControllerSettings=function(callback,ip,token){if(!ip&&!token&&!$rootScope.activeController)return void callback(!1);$http=$http||$injector.get("$http");var promise;return promise=$http(token||!ip&&$rootScope.activeController&&$rootScope.activeController.auth?{method:"POST",url:"https://opensprinkler.com/wp-admin/admin-ajax.php",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:"action=blynkCloud&path="+encodeURIComponent(token||$rootScope.activeController.auth)+"/query",suppressLoader:!0}:{method:"GET",url:"http://"+(ip||$rootScope.activeController.ip)+"/jc",suppressLoader:!ip}),promise.then(function(result){if(token||!ip&&$rootScope.activeController&&$rootScope.activeController.auth){$filter=$filter||$injector.get("$filter");var filter=$filter("filter");result=result.data[0],callback({name:result.name,door:parseInt(filter(result.pins,{pin:0})[0].value),dist:parseInt(filter(result.pins,{pin:3})[0].value),rcnt:parseInt(filter(result.pins,{pin:4})[0].value)})}else callback(result.data)},function(){callback(!1)})},getControllerOptions=function(callback,ip,showLoader){return!ip&&!$rootScope.activeController||$rootScope.activeController&&!$rootScope.activeController.ip?void callback(!1):($http=$http||$injector.get("$http"),$http({method:"GET",url:"http://"+(ip||$rootScope.activeController.ip)+"/jo",suppressLoader:!showLoader}).then(function(result){callback(result.data)},function(){callback(!1)}))},updateController=function(){$q=$q||$injector.get("$q");var controller=angular.copy($rootScope.activeController),save=function(data){angular.extend(controller,data)};$q.when().then(function(){return getControllerSettings(save)}).then(function(){return getControllerOptions(save)}).then(function(){var index=$rootScope.controllers.indexOf($rootScope.activeController);$rootScope.controllers.splice(index,1),$rootScope.controllers.splice(index,0,controller),$rootScope.activeController=controller,$rootScope.$broadcast("controllerUpdated"),storage.set({controllers:JSON.stringify($rootScope.controllers),activeController:JSON.stringify($rootScope.activeController)})})},addController=function(data,callback){return $ionicPopup=$ionicPopup||$injector.get("$ionicPopup"),data.token||data.ip&&data.password?data.token&&32!==data.token.length?($ionicPopup.alert({template:"<p class='center'>A valid Blynk token is required. Please verify your token and try again.</p>"}),void callback(!1)):void getControllerSettings(function(result){if(result||($ionicPopup.alert({template:"<p class='center'>Unable to find device. Please verify the IP/password and try again.</p>"}),callback(!1)),result.mac){if(result.ip=data.ip,result.password=data.password,$filter=$filter||$injector.get("$filter"),$filter("filter")($rootScope.controllers,{mac:result.mac}).length>0)return $ionicPopup.alert({template:"<p class='center'>Device already added to site list.</p>"}),void callback(!1);getControllerOptions(function(reply){angular.extend(result,reply),$rootScope.controllers.push(result),storage.set({controllers:JSON.stringify($rootScope.controllers)}),callback(!0)},data.ip)}data.token&&$http({method:"POST",url:"https://opensprinkler.com/wp-admin/admin-ajax.php",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:"action=blynkCloud&path="+data.token+"/get/V2",suppressLoader:!0}).then(function(reply){reply=reply.data.pop().split(" ")[1].split("_")[1],result.mac="5C:CF:7F"+reply.match(/.{1,2}/g).join(":"),result.auth=data.token,$rootScope.controllers.push(result),storage.set({controllers:JSON.stringify($rootScope.controllers)}),callback(!0)})},data.token?null:data.ip,data.token?data.token:null):($ionicPopup.alert({template:"<p class='center'>Both an IP and password are required.</p>"}),void callback(!1))};return isFireFox&&(HTMLElement.prototype.click=function(){var evt=this.ownerDocument.createEvent("MouseEvents");evt.initMouseEvent("click",!0,!0,this.ownerDocument.defaultView,1,0,0,0,0,!1,!1,!1,!1,0,null),this.dispatchEvent(evt)}),{isIE:isIE,storage:storage,getControllerSettings:getControllerSettings,getControllerOptions:getControllerOptions,updateController:updateController,showAddController:function(callback){callback=callback||function(){},$ionicPopup=$ionicPopup||$injector.get("$ionicPopup");var scope=$rootScope.$new();scope.data={},$ionicPopup.show({templateUrl:"templates/addController.html",title:"Add Controller",scope:scope,buttons:[{text:"Cancel"},{text:"<b>Add</b>",type:"button-positive",onTap:function(e){return!(!scope.data.ip||!scope.data.password)||void e.preventDefault()}}]}).then(function(isValid){isValid&&addController(scope.data,callback)})},showAddBlynk:function(callback){callback=callback||function(){},$ionicPopup=$ionicPopup||$injector.get("$ionicPopup"),$ionicPopup.prompt({title:"Add Controller by Blynk",template:"Enter your Blynk Auth token below:",inputType:"text",inputPlaceholder:"Your Blynk Auth token"}).then(function(token){token&&addController({token:token},callback)})},toggleDoor:function(callback){callback=callback||function(){},$http=$http||$injector.get("$http");var promise;promise=$rootScope.activeController&&$rootScope.activeController.auth?$http({method:"POST",url:"https://opensprinkler.com/wp-admin/admin-ajax.php",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:"action=blynkCloud&path="+encodeURIComponent($rootScope.activeController.auth+"/update/V1?value=1")}).then(function(){setTimeout(function(){$http({method:"POST",url:"https://opensprinkler.com/wp-admin/admin-ajax.php",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:"action=blynkCloud&path="+encodeURIComponent($rootScope.activeController.auth+"/update/V1?value=0")})},1e3)}):$http.get("http://"+$rootScope.activeController.ip+"/cc?dkey="+encodeURIComponent($rootScope.activeController.password)+"&click=1"),promise.then(function(){callback(!0)},function(){callback(!1)})},saveOptions:function(settings,callback){return $http=$http||$injector.get("$http"),$http({method:"GET",url:"http://"+$rootScope.activeController.ip+"/co?dkey="+$rootScope.activeController.password,params:settings,paramSerializer:"$httpParamSerializerJQLike"}).then(function(result){callback(result.data)},function(){callback(!1)})},changePassword:function(){$ionicPopup=$ionicPopup||$injector.get("$ionicPopup");var scope=$rootScope.$new();scope.pwd={},$ionicPopup.show({templateUrl:"templates/changePassword.html",title:"Change Password",scope:scope,buttons:[{text:"Cancel"},{text:"<b>Go</b>",type:"button-positive"}]}).then(function(){scope.pwd.nkey&&scope.pwd.ckey&&scope.pwd.nkey===scope.pwd.ckey&&($http=$http||$injector.get("$http"),$http({method:"GET",url:"http://"+$rootScope.activeController.ip+"/co?dkey="+$rootScope.activeController.password,params:scope.pwd,paramSerializer:"$httpParamSerializerJQLike"}).then(function(){$rootScope.activeController.password=scope.pwd.nkey;var index=$rootScope.controllers.indexOf($rootScope.activeController);$rootScope.controllers.splice(index,1),$rootScope.controllers.splice(index,0,$rootScope.activeController),storage.set({controllers:JSON.stringify($rootScope.controllers),activeController:JSON.stringify($rootScope.activeController)}),$ionicPopup.alert({template:"<p class='center'>Password updated succesfully!</p>"})}))})},getLogs:function(callback){$http=$http||$injector.get("$http"),$http({method:"GET",url:"http://"+$rootScope.activeController.ip+"/jl"}).then(function(result){callback(result.data.logs.reverse())},function(){callback(!1)})}}}]);null//# sourceMappingURL=app.min.js.mapnull